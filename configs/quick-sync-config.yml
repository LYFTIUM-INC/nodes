version: '3.8'

services:
  # Ethereum with snap sync
  ethereum-geth:
    image: ethereum/client-go:v1.13.15
    container_name: ethereum-geth
    restart: unless-stopped
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
      - "30303:30303/udp"
    volumes:
      - /data/blockchain/storage/ethereum:/root/.ethereum
    command: |
      --mainnet
      --http
      --http.addr=0.0.0.0
      --http.port=8545
      --http.api=eth,net,web3,debug,txpool
      --http.vhosts='*'
      --http.corsdomain='*'
      --ws
      --ws.addr=0.0.0.0
      --ws.port=8546
      --ws.api=eth,net,web3,debug,txpool
      --ws.origins='*'
      --nat=extip:51.159.82.58
      --syncmode=snap
      --maxpeers=100
      --cache=4096
      --snapshot=true
      --bootnodes=enode://d860a01f9722d78051619d1e2351aba3f43f943f6f00718d1b9baa4101932a1f5011f16bb2b1bb35db20d6fe28fa0bf09636d26a87d31de9ec6203eeedb1f666@18.138.108.67:30303,enode://22a8232c3abc76a16ae9d6c3b164f98775fe226f0917b0ca871128a74a8e9630b458460865bab457221f1d448dd9791d24c4e5d88786180ac185df813a68d4de@3.209.45.79:30303
    networks:
      - blockchain_network

  # Polygon with snapshot download
  polygon-bor:
    image: 0xpolygon/bor:1.3.2
    container_name: polygon-bor
    restart: unless-stopped
    ports:
      - "8547:8545"
      - "8549:8546"
      - "30307:30303"
      - "30307:30303/udp"
    volumes:
      - /data/blockchain/storage/polygon:/bor-home
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "
      if [ ! -f /bor-home/genesis.json ]; then
        echo 'Initializing Polygon Bor...'
        curl -L https://raw.githubusercontent.com/maticnetwork/bor/master/params/mainnet/genesis.json > /bor-home/genesis.json
        bor --datadir /bor-home init /bor-home/genesis.json
      fi
      
      echo 'Starting Bor with public Heimdall RPC...'
      bor server \
        --chain=mainnet \
        --datadir=/bor-home \
        --port=30303 \
        --http \
        --http.addr=0.0.0.0 \
        --http.port=8545 \
        --http.api=eth,net,web3,txpool,bor \
        --http.vhosts='*' \
        --http.corsdomain='*' \
        --ws \
        --ws.addr=0.0.0.0 \
        --ws.port=8546 \
        --ws.api=eth,net,web3,txpool,bor \
        --ws.origins='*' \
        --bor.heimdall=https://heimdall-api.polygon.technology \
        --syncmode=full \
        --gcmode=full \
        --maxpeers=200 \
        --bootnodes=enode://b8f1cc9c5d4403703fbf377116469667d2b1823c0daf16b7250aa576bacf399e42c3930ccfcb02c5df6879565a2b8931335565f0e8d3f8e72385ecf4a4bf160a@3.36.224.80:30303,enode://8729e0c825f3d9cad382555f3e46dcff21af323e89025a0e6312df541f4a9e73abfa562d64906f5e59c51fe6f0501b3e61b07979606c56329c020ed739910759@54.194.245.5:30303
      "
    networks:
      - blockchain_network

  # Arbitrum with public L1
  arbitrum-node:
    image: offchainlabs/nitro-node:v3.2.1-d81324d
    container_name: arbitrum-node
    restart: unless-stopped
    ports:
      - "8548:8547"
      - "8550:8548"
    volumes:
      - /data/blockchain/storage/arbitrum:/home/user/.arbitrum
    command: |
      --parent-chain.connection.url=https://ethereum-rpc.publicnode.com
      --chain.id=42161
      --http.addr=0.0.0.0
      --http.port=8547
      --http.vhosts=*
      --http.corsdomain=*
      --http.api=net,web3,eth,arb
      --ws.addr=0.0.0.0
      --ws.port=8548
      --ws.origins=*
      --ws.api=net,web3,eth,arb
      --init.url=https://snapshot.arbitrum.foundation/arb1/nitro-pruned.tar
      --node.data-availability.enable
      --node.data-availability.rest-aggregator.enable
      --node.data-availability.rest-aggregator.urls=https://anytrust-mainnet.arbitrum.io/daserver
      --validation.use-jit=false
      --node.batch-poster.enable=false
    networks:
      - blockchain_network

networks:
  blockchain_network:
    external: true