version: '3.8'

networks:
  mev_foundation_network:
    external: true

services:
  # MEV-Boost - Builder API with properly formatted relay URL
  mev-boost:
    image: flashbots/mev-boost:latest
    container_name: mev-boost-foundation
    restart: unless-stopped
    ports:
      - "28550:18550"   # Builder API
      - "18551:18551"   # Metrics
    volumes:
      - ./configs/mev-boost:/configs
      - /data/mev/data:/data
      - /data/blockchain/nodes/jwt-secret-common.hex:/data/jwt-secret.hex:ro
    environment:
      - LOG_LEVEL=info
      - JSON_LOGS=true
    command: ["mev-boost", "--mainnet", "--addr", "0.0.0.0:18550", "--metrics-addr", "0.0.0.0:18551", "--relay", "https://0xac6e77dfe25ecd6110b8e780608cce0dab71fdd5ebea22a16c0205200f2f8e2e3ad3b71d3499c54ad14d6c21b41a37ae@boost-relay.flashbots.net", "--relay", "https://0x8b5d2e73e2a3a55c6c87b8b6eb92e0149a125c852751db1422fa951e42a09b82c142c3ea98d0d9930b056a3bc9896b8f@bloxroute.max-profit.blxrbdn.com"]
    networks:
      - mev_foundation_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:18550"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # RBuilder - Optional MEV builder
  rbuilder:
    image: node:18-alpine
    container_name: rbuilder-foundation
    restart: unless-stopped
    ports:
      - "18552:3000"   # RBuilder API
      - "6065:6065"     # Metrics
    volumes:
      - /data/blockchain/nodes/jwt-secret-common.hex:/data/jwt-secret.hex:ro
    working_dir: /app
    command: ["sh", "-c", "npm install && npm start"]
    networks:
      - mev_foundation_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus-mev-foundation
    restart: unless-stopped
    ports:
      - "19091:9090"
    volumes:
      - /data/blockchain/nodes/configs/monitoring/prometheus-foundation.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-foundation-data:/prometheus/data
    command: >
      --config.file=/etc/prometheus/prometheus.yml
      --storage.tsdb.path=/prometheus/data
      --web.enable-lifecycle
    networks:
      - mev_foundation_network

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana-mev-foundation
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - /data/blockchain/nodes/configs/grafana:/etc/grafana
      - /data/blockchain/nodes/data/grafana-foundation:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=mev_foundation_2025
      - GF_PATHS_CONFIG=/etc/grafana/grafana.ini
    networks:
      - mev_foundation_network
    depends_on:
      - prometheus

volumes:
  prometheus-foundation-data:
    driver: local
  grafana-foundation-data:
    driver: local
