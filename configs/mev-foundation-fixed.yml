version: '3.8'

networks:
  mev_foundation_network:
    external: true

services:
  # MEV-Boost - Builder API with corrected relay configuration
  mev-boost:
    image: flashbots/mev-boost:latest
    container_name: mev-boost-foundation
    restart: unless-stopped
    ports:
      - "18550:18550"   # Builder API
      - "18551:18551"   # Metrics
    volumes:
      - ./configs/mev-boost:/configs
      - /data/mev/data:/data
      - /data/blockchain/nodes/jwt-secret-common.hex:/data/jwt-secret.hex:ro
    environment:
      - BOOST_RELAY_URLS=https://0xa1559ace749633b994cbf2b7a567c85db40f0b32c4d8e4a54d5d5abf5770ad683a4c8b0f@boost-relay.flashbots.net,https://0xac6e78d925976533027b258a5cba1249d433317d56b8b1ff743aa33affd819f244031d543@relay.edennetwork.io
      - BOOST_BUILDER_API_PORT=18550
      - BOOST_METRICS_PORT=18551
      - BOOST_MIN_BID_ETH=0.01
      - BOOST_BID_TTL=6
      - BOOST_PRIVATE_KEY_FILE=/data/mev-boost-key.json
      - BOOST_REORG_EXTRA_DATA=true
      - BOOST_BUILDER_EXTRA_DATA_FILE=/data/builder-extra-data.json
      - BOOST_LOG_LEVEL=info
      - BOOST_LOG_FORMAT=json
      - BOOST_RPC_URL=http://127.0.0.1:8545
      - BOOST_RPC_TIMEOUT=5000
      - BOOST_MAX_CONNECTIONS=100
      - BOOST_RATE_LIMIT_PER_SEC=1000
      - BOOST_GENESIS_FORKS_FILE=/configs/genesis-forks.json
      - BOOST_CHECK_RELAY_INTERVAL=1000
      - ENV=production
    command: ["mev-boost", "-mainnet", "-relay-urls", "https://0xa1559ace749633b994cbf2b7a567c85db40f0b32c4d8e4a54d5d5abf5770ad683a4c8b0f@boost-relay.flashbots.net,https://0xac6e78d925976533027b258a5cba1249d433317d56b8b1ff743aa33affd819f244031d543@relay.edennetwork.io"]
    networks:
      - mev_foundation_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:18550"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # RBuilder - Advanced block building
  rbuilder:
    image: builder0x69/rbuilder:latest
    container_name: rbuilder-foundation
    restart: unless-stopped
    ports:
      - "18552:18550"   # Builder API (different port to avoid conflict)
      - "8547:8547"     # RPC
      - "6065:6065"     # Metrics
    volumes:
      - ./configs/rbuilder:/configs
      - /data/rbuilder:/data
      - /data/blockchain/nodes/jwt-secret-common.hex:/data/jwt-secret.hex:ro
    environment:
      - RBUILDER_BUILDER_API_PORT=18550
      - RBUILDER_RPC_PORT=8547
      - RBUILDER_METRICS_PORT=6065
      - RBUILDER_SECRET_KEY=/data/builder-key.json
      - RBUILDER_ELIGIBLE_ADDRESSES_FILE=/configs/eligible-builders.json
      - RBUILDER_BUILDER_NAME=MEV-Foundation-Builder
      - RBUILDER_GAS_LIMIT=30000000
      - RBUILDER_MAX_PROFIT_MARGIN=5
      - RBUILDER_MIN_PROFIT_MARGIN=0.1
      - RBUILDER_PRIVATE_KEY_FILE=/data/private-key.json
      - RBUILDER_LOG_LEVEL=info
      - RBUILDER_CHECK_RELAY=true
      - RBUILDER_REORG_DELAY=3
      - RBUILDER_EXTRA_DATA_FILE=/data/extra-data.json
      - PYTHONPATH=/opt/mev-lab
      - ENV=production
      - RBUILDER_RELAYS=https://0xa1559ace749633b994cbf2b7a567c85db40f0b32c4d8e4a54d5d5abf5770ad683a4c8b0f@boost-relay.flashbots.net
    command: |
      rbuilder
      --secret-key-file /data/builder-key.json
      --builder-api-port 18550
      --rpc-port 8547
      --metrics-port 6065
      --eligible-addresses-file /configs/eligible-builders.json
      --builder-name MEV-Foundation-Builder
      --gas-limit 30000000
      --max-profit-margin 5
      --min-profit-margin 0.1
      --log-level info
      --check-relay
      --reorg-delay 3
      --extra-data-file /data/extra-data.json
      --rpc-url http://127.0.0.1:8545
    networks:
      - mev_foundation_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:18550"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus-mev-foundation
    restart: unless-stopped
    ports:
      - "19091:9090"     # Different port to avoid conflict
    volumes:
      - /data/blockchain/nodes/configs/monitoring/prometheus-foundation.yml:/etc/prometheus/prometheus.yml:ro
      - /data/blockchain/nodes/monitoring/rules:/etc/prometheus/rules
      - prometheus-foundation-data:/prometheus/data
    command: |
      --config.file=/etc/prometheus/prometheus.yml \
      --storage.tsdb.path=/prometheus/data \
      --web.console.templates=/etc/prometheus/console \
      --web.console.libraries=/etc/prometheus/console_libraries
    networks:
      - mev_foundation_network

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana-mev-foundation
    restart: unless-stopped
    ports:
      - "3001:3000"     # Different port to avoid conflict
    volumes:
      - /data/blockchain/nodes/configs/grafana:/etc/grafana
      - /data/blockchain/nodes/data/grafana-foundation:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=mev_foundation_2025
      - PYTHONPATH=/opt/mev-lab
    networks:
      - mev_foundation_network
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Volume definitions
volumes:
  prometheus-foundation-data:
    driver: local
  rbuilder-data:
    driver: local
  grafana-foundation-data:
    driver: local