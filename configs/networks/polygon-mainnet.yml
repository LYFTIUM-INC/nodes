version: '3.8'

services:
  # Heimdall - Polygon consensus layer (must start first)
  polygon-heimdall:
    image: 0xpolygon/heimdall:1.0.3
    container_name: polygon-heimdall
    restart: unless-stopped
    ports:
      - "26656:26656"   # P2P
      - "26657:26657"   # RPC
      - "1317:1317"     # REST API
      - "26660:26660"   # Prometheus metrics
    volumes:
      - /data/blockchain/storage/polygon-heimdall:/var/lib/heimdall
    environment:
      - HEIMDALL_CHAIN_ID=heimdall-137
      - HEIMDALL_SNAPSHOT_URL=https://matic-blockchain-snapshots.s3-accelerate.amazonaws.com/matic-mainnet/heimdall-snapshot-2024-06-30.tar.gz
    command: |
      bash -c "
        if [ ! -f /var/lib/heimdall/config/genesis.json ]; then
          heimdalld init --chain-id heimdall-137
          curl -L https://raw.githubusercontent.com/maticnetwork/heimdall/master/builder/files/genesis-mainnet-v1.json > /var/lib/heimdall/config/genesis.json
          sed -i 's/localhost/0.0.0.0/g' /var/lib/heimdall/config/config.toml
          sed -i 's/127.0.0.1/0.0.0.0/g' /var/lib/heimdall/config/app.toml
          sed -i 's/laddr = \"tcp:\/\/127.0.0.1:26657\"/laddr = \"tcp:\/\/0.0.0.0:26657\"/g' /var/lib/heimdall/config/config.toml
          sed -i 's/cors_allowed_origins = \\[\\]/cors_allowed_origins = \\[\"*\"\\]/g' /var/lib/heimdall/config/config.toml
          sed -i 's/seeds = \"\"/seeds = \"6b74281e6b5f7401364f7eeca2c09feac5ee3e3f@34.67.28.80:26656,ff29aeb5cdf25cd1072adf04e5db2dddc5b093a5@34.226.134.117:26656\"/g' /var/lib/heimdall/config/config.toml
        fi
        heimdalld start --rest-server --chain-id heimdall-137
      "
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1317/node_info"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    networks:
      - blockchain_network

  # Bor - Polygon execution layer
  polygon-bor:
    image: 0xpolygon/bor:1.3.2
    container_name: polygon-bor  
    restart: unless-stopped
    depends_on:
      polygon-heimdall:
        condition: service_healthy
    ports:
      - "8547:8545"     # HTTP RPC
      - "8549:8546"     # WebSocket RPC  
      - "30307:30303"   # P2P TCP
      - "30307:30303/udp" # P2P UDP
      - "6063:6060"     # Metrics
    volumes:
      - /data/blockchain/storage/polygon:/var/lib/bor
    command: |
      bash -c "
        if [ ! -f /var/lib/bor/genesis.json ]; then
          curl -L https://raw.githubusercontent.com/maticnetwork/bor/master/params/mainnet/genesis.json > /var/lib/bor/genesis.json
          bor init /var/lib/bor/genesis.json --datadir /var/lib/bor
        fi
        bor server \
          --chain=mainnet \
          --datadir=/var/lib/bor \
          --port=30303 \
          --http \
          --http.addr=0.0.0.0 \
          --http.port=8545 \
          --http.api=eth,net,web3,txpool,bor,admin,debug,trace \
          --http.vhosts='*' \
          --http.corsdomain='*' \
          --ws \
          --ws.addr=0.0.0.0 \
          --ws.port=8546 \
          --ws.api=eth,net,web3,txpool,bor \
          --ws.origins='*' \
          --bor.heimdall=http://polygon-heimdall:1317 \
          --syncmode=snap \
          --snapshot=true \
          --gcmode=full \
          --metrics \
          --metrics.addr=0.0.0.0 \
          --metrics.port=6060 \
          --maxpeers=200 \
          --nat=any \
          --bootnodes=enode://b8f1cc9c5d4403703fbf377116469667d2b1823c0daf16b7250aa576bacf399e42c3930ccfcb02c5df6879565a2b8931335565f0e8d3f8e72385ecf4a4bf160a@3.36.224.80:30303,enode://8729e0c825f3d9cad382555f3e46dcff21af323e89025a0e6312df541f4a9e73abfa562d64906f5e59c51fe6f0501b3e61b07979606c56329c020ed739910759@54.194.245.5:30303
      "
    environment:
      - BOR_CHAIN=mainnet
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '3.0'
        reservations:
          memory: 4G
          cpus: '2.0'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s
    networks:
      - blockchain_network

networks:
  blockchain_network:
    external: true