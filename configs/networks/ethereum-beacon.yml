version: '3.8'

services:
  # Consensus Layer - Lighthouse Beacon
  ethereum-beacon:
    image: sigp/lighthouse:v5.1.3
    container_name: ethereum-beacon
    restart: unless-stopped
    ports:
      - "5052:5052"     # HTTP API
      - "9000:9000"     # P2P TCP
      - "9000:9000/udp" # P2P UDP
    volumes:
      - /data/blockchain/storage/ethereum-beacon:/root/.lighthouse
    command: |
      lighthouse bn
      --network mainnet
      --http
      --http-address 0.0.0.0
      --http-port 5052
      --execution-endpoint http://ethereum-geth:8551
      --execution-jwt /root/.lighthouse/jwt.hex
      --checkpoint-sync-url https://mainnet.checkpoint.sigp.io
      --disable-deposit-contract-sync
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "2.0"
    networks:
      - blockchain_network
    depends_on:
      - ethereum-geth

  # Update Geth to work with beacon
  ethereum-geth-update:
    image: ethereum/client-go:v1.13.15
    container_name: ethereum-geth-update
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "
      # Copy JWT secret between containers
      if [ ! -f /data/.ethereum/geth/jwtsecret ]; then
        echo 'Waiting for JWT secret...'
        sleep 10
      fi
      cp /data/.ethereum/geth/jwtsecret /beacon/.lighthouse/jwt.hex
      echo 'JWT secret copied'
      "
    volumes:
      - /data/blockchain/storage/ethereum:/data/.ethereum
      - /data/blockchain/storage/ethereum-beacon:/beacon/.lighthouse
    networks:
      - blockchain_network

networks:
  blockchain_network:
    external: true