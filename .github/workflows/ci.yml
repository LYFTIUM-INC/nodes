name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run TruffleHog (Secret Scanning)
        run: |
          docker run --rm -v "$PWD:/workspace" trufflesecurity/trufflehog:latest \
            filesystem --directory /workspace --only-verified

      - name: Check for exposed credentials
        run: |
          # Check for common secret patterns
          grep -r "sk_live_" . 2>/dev/null && exit 1 || true
          grep -r "api_key" . --include="*.py" --include="*.sh" --exclude-dir=".git" && echo "WARNING: api_key found"
          grep -r "password.*=" . --include="*.yml" --include="*.yaml" --exclude-dir=".git" && echo "WARNING: passwords in config"

  lint-python:
    name: Python Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install ruff mypy

      - name: Run Ruff
        run: |
          ruff check . --output-format=github

      - name: Run Ruff Format Check
        run: |
          ruff format --check .

      - name: Type Check (mypy)
        run: |
          mypy --strict . || true

  lint-shell:
    name: Shell Script Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          find . -name "*.sh" -type f -exec shellcheck {} +

  validate-docker-compose:
    name: Validate Docker Compose Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose files
        run: |
          for file in $(find . -name "docker-compose*.yml" -o -name "docker-compose*.yaml"); do
            echo "Validating $file"
            docker-compose -f "$file" config --quiet
          done

  validate-environment:
    name: Validate Environment Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check .env.example exists
        run: |
          test -f .env.example || echo "WARNING: .env.example not found"

      - name: Check for .env files in git
        run: |
          if git ls-files | grep -E "\.env$"; then
            echo "ERROR: .env files should not be committed"
            exit 1
          fi

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check README.md is up to date
        run: |
          # Check if README.md has been updated in last 30 days
          README_DATE=$(git log -1 --format=%ai README.md | cut -d' ' -f1)
          TODAY=$(date +%Y-%m-%d)
          README_TS=$(date -d "$README_DATE" +%s)
          TODAY_TS=$(date -d "$TODAY" +%s)
          DIFF=$(( ($TODAY_TS - $README_TS) / 86400 ))

          if [ $DIFF -gt 30 ]; then
            echo "WARNING: README.md is $DIFF days old. Consider updating."
          fi

      - name: Check for broken links
        run: |
          # Install markdown-link-check
          npm install -g markdown-link-check

          # Check all markdown files
          find . -name "*.md" -type f -exec markdown-link-check {} +

  commit-message-lint:
    name: Commit Message Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          # Get all commits in this PR
          commits=$(git log --format='%H' origin/main..HEAD)

          for commit in $commits; do
            msg=$(git log -1 --format='%s' $commit)
            echo "Checking: $msg"

            # Check conventional commit format
            if ! echo "$msg" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci|security|revert)(\(.+\))?: .{1,72}'; then
              echo "ERROR: Invalid commit message format: $msg"
              echo "Expected: <type>(<scope>): <subject>"
              exit 1
            fi
          done

  infrastructure-test:
    name: Infrastructure Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check .gitignore
        run: |
          # Ensure .gitignore exists and has blockchain-specific entries
          test -f .gitignore || (echo "ERROR: .gitignore not found" && exit 1)

          # Check for critical exclusions
          for pattern in "chaindata" "snapshots" "*.log" "*.key" ".env"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "WARNING: .gitignore missing pattern: $pattern"
            fi
          done

      - name: Check for duplicate directories
        run: |
          # Check for docs/ + docs_archive/ + documentation/
          if [ -d "docs" ] && [ -d "docs_archive" ] && [ -d "documentation" ]; then
            echo "ERROR: Duplicate documentation directories detected"
            exit 1
          fi

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [security-scan, lint-python, lint-shell, validate-docker-compose, validate-environment]
    if: success()
    steps:
      - name: Send success notification
        run: |
          echo "âœ… All CI/CD checks passed successfully!"
