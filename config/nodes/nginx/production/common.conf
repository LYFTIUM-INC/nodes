# Common SSL Configuration
# /etc/nginx/ssl-common.conf
ssl_certificate /etc/ssl/certs/lyftium.com.crt;
ssl_certificate_key /etc/ssl/private/lyftium.com.key;
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256;
ssl_prefer_server_ciphers on;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;

# Rate limiting
limit_req zone=api_limit burst=50 nodelay;
limit_conn conn_limit_per_ip 10;

# Security headers
add_header X-Frame-Options DENY always;
add_header X-Content-Type-Options nosniff always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# CORS Headers
add_header Access-Control-Allow-Origin "https://app.lyftium.com" always;
add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key" always;

# Common Authentication
# /etc/nginx/auth-common.conf
if ($http_x_api_key = "") {
    return 401;
}

access_by_lua_block {
    local api_key = ngx.var.http_x_api_key
    local valid_keys = {
        ["4fbcbb3ebca04e79263ff3c9a65c5bed"] = "monitoring",
        ["b9b4066482aab19b51da46ce07014b87"] = "mev_executor",
        ["65497c3178b8ba58b2b8eed2d233a9fe"] = "admin"
    }
    
    if not valid_keys[api_key] then
        ngx.status = 401
        ngx.say("Invalid API key")
        ngx.exit(401)
    end
}

# Common Proxy Settings
# /etc/nginx/proxy-common.conf
proxy_http_version 1.1;
proxy_set_header Connection "";
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# Timeout settings optimized for blockchain RPC
proxy_connect_timeout 5s;
proxy_send_timeout 30s;
proxy_read_timeout 60s;

# Buffer settings for performance
proxy_buffering on;
proxy_buffer_size 8k;
proxy_buffers 8 8k;
proxy_busy_buffers_size 16k;

# Enable caching for static responses
proxy_cache_methods GET HEAD POST;
proxy_cache_key $scheme$proxy_host$uri$is_args$args$request_body;
proxy_cache_valid 200 1m;