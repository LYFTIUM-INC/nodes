# Nginx RPC Proxy Configuration for Lyftium Blockchain Infrastructure
# High-performance, secure RPC endpoint proxy with rate limiting and SSL

upstream ethereum_rpc {
    server 127.0.0.1:8545 max_fails=3 fail_timeout=30s weight=5;
    server 127.0.0.1:8565 max_fails=3 fail_timeout=30s weight=1 backup;
    keepalive 32;
}

upstream optimism_rpc {
    server 127.0.0.1:8546 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream base_rpc {
    server 127.0.0.1:8548 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream polygon_rpc {
    server 127.0.0.1:8549 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream arbitrum_rpc {
    server 127.0.0.1:8560 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=rpc_limit:10m rate=100r/m;
limit_req_zone $http_x_api_key zone=api_limit:10m rate=1000r/m;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

server {
    listen 8443 ssl http2;
    server_name eth.rpc.lyftium.com;
    
    # SSL Configuration
    ssl_certificate /etc/ssl/certs/lyftium.com.crt;
    ssl_certificate_key /etc/ssl/private/lyftium.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;
    
    # Rate limiting
    limit_req zone=api_limit burst=50 nodelay;
    limit_conn conn_limit_per_ip 10;
    
    # CORS Headers
    add_header Access-Control-Allow-Origin "https://app.lyftium.com" always;
    add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key" always;
    
    # API Key Authentication
    location / {
        # Validate API key
        if ($http_x_api_key = "") {
            return 401;
        }
        
        # Check against valid keys
        access_by_lua_block {
            local api_key = ngx.var.http_x_api_key
            local valid_keys = {
                ["4fbcbb3ebca04e79263ff3c9a65c5bed"] = "monitoring",
                ["b9b4066482aab19b51da46ce07014b87"] = "mev_executor", 
                ["65497c3178b8ba58b2b8eed2d233a9fe"] = "admin"
            }
            
            if not valid_keys[api_key] then
                ngx.status = 401
                ngx.say("Invalid API key")
                ngx.exit(401)
            end
        }
        
        proxy_pass http://ethereum_rpc;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Timeout settings
        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # Buffer settings for performance
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
}

# Base Chain RPC
server {
    listen 8443 ssl http2;
    server_name base.rpc.lyftium.com;
    
    include /etc/nginx/ssl-common.conf;
    
    location / {
        include /etc/nginx/auth-common.conf;
        proxy_pass http://base_rpc;
        include /etc/nginx/proxy-common.conf;
    }
}

# Optimism RPC  
server {
    listen 8443 ssl http2;
    server_name optimism.rpc.lyftium.com;
    
    include /etc/nginx/ssl-common.conf;
    
    location / {
        include /etc/nginx/auth-common.conf;
        proxy_pass http://optimism_rpc;
        include /etc/nginx/proxy-common.conf;
    }
}

# Polygon RPC
server {
    listen 8443 ssl http2;
    server_name polygon.rpc.lyftium.com;
    
    include /etc/nginx/ssl-common.conf;
    
    location / {
        include /etc/nginx/auth-common.conf;
        proxy_pass http://polygon_rpc;
        include /etc/nginx/proxy-common.conf;
    }
}

# Arbitrum RPC
server {
    listen 8443 ssl http2;
    server_name arbitrum.rpc.lyftium.com;
    
    include /etc/nginx/ssl-common.conf;
    
    location / {
        include /etc/nginx/auth-common.conf;
        proxy_pass http://arbitrum_rpc;
        include /etc/nginx/proxy-common.conf;
    }
}