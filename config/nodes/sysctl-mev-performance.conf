# System Performance Tuning for MEV Infrastructure
# Optimized for 62GB RAM, 32-core CPU MEV operations
# Target: Sub-5ms latency, maximum throughput

# Network performance optimizations
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.core.netdev_max_backlog = 5000
net.core.netdev_budget = 600
net.core.somaxconn = 65535

# TCP optimizations for high-frequency trading
net.ipv4.tcp_rmem = 4096 524288 16777216
net.ipv4.tcp_wmem = 4096 524288 16777216
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_max_tw_buckets = 2000000
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_no_metrics_save = 1

# Memory management for 62GB system
vm.swappiness = 10
vm.dirty_ratio = 5
vm.dirty_background_ratio = 2
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100
vm.vfs_cache_pressure = 50
vm.min_free_kbytes = 1048576
vm.zone_reclaim_mode = 0
vm.overcommit_memory = 1
vm.overcommit_ratio = 50

# Huge pages for performance-critical applications
vm.nr_hugepages = 1024
vm.hugetlb_shm_group = 1000

# File system optimizations
fs.file-max = 2097152
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512
fs.aio-max-nr = 1048576

# Process and thread limits
kernel.pid_max = 4194304
kernel.threads-max = 2097152

# Scheduler optimizations for real-time performance
kernel.sched_migration_cost_ns = 5000000
kernel.sched_autogroup_enabled = 0
kernel.sched_rt_period_us = 1000000
kernel.sched_rt_runtime_us = 950000

# CPU frequency scaling (performance governor)
# Note: This requires cpufreq governor to be set to performance
# echo performance > /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Security settings that don't impact performance
kernel.yama.ptrace_scope = 1
kernel.kptr_restrict = 1
kernel.dmesg_restrict = 1

# Increase limits for high-performance applications
# These correspond to /etc/security/limits.conf settings
# * soft nofile 1048576
# * hard nofile 1048576
# * soft nproc 65536
# * hard nproc 65536

# Networking buffers for high-throughput RPC
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192
net.core.rmem_default = 262144
net.core.wmem_default = 262144

# Disable IPv6 if not needed (reduces overhead)
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1

# Increase local port range
net.ipv4.ip_local_port_range = 1024 65535

# Reduce TIME_WAIT socket timeout
net.ipv4.tcp_fin_timeout = 15

# Increase maximum number of open files
fs.file-max = 2097152

# Optimize for SSD storage
# Enable deadline scheduler for SSDs
# echo deadline > /sys/block/sda/queue/scheduler

# Transparent huge pages (disable for databases)
# echo never > /sys/kernel/mm/transparent_hugepage/enabled
# echo never > /sys/kernel/mm/transparent_hugepage/defrag

# CPU isolation for critical processes (optional)
# isolcpus=2-31 (reserve CPUs 2-31 for MEV processes)

# IRQ affinity for network cards
# echo 2 > /proc/irq/24/smp_affinity  # Example for network card IRQ

# NUMA optimizations
vm.numa_balancing = 0

# Disable unnecessary services impact
kernel.nmi_watchdog = 0
kernel.hung_task_timeout_secs = 0

# Memory allocation optimizations
vm.max_map_count = 262144

# Network namespace optimizations
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_timeout_established = 7200
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120

# Increase the maximum number of memory map areas a process can have
vm.max_map_count = 262144

# Optimize for high-frequency memory allocation
kernel.randomize_va_space = 1