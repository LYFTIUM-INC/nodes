# MEV-Optimized Erigon Configuration
# Designed for maximum peer connectivity and MEV performance

version: '3.8'

networks:
  mev_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24

volumes:
  erigon_mev_data:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '/data/blockchain/storage/erigon-fresh'

services:
  erigon_mev:
    image: erigontech/erigon:v2.60.8
    container_name: erigon_mev_optimized
    hostname: erigon-mev
    command: >
      erigon
      --datadir=/var/lib/erigon
      --chain=mainnet
      --prune.mode=full
      --http
      --http.addr=0.0.0.0
      --http.port=8545
      --http.vhosts=*
      --http.api=eth,net,web3,txpool,erigon,debug,trace,engine
      --http.corsdomain=*
      --ws
      --ws.addr=0.0.0.0
      --ws.port=8546
      --ws.api=eth,net,web3,txpool,erigon,debug,trace
      --ws.origins=*
      --authrpc.addr=0.0.0.0
      --authrpc.port=8551
      --authrpc.jwtsecret=/var/lib/erigon/jwt.hex
      --authrpc.vhosts=*
      --port=30303
      --nat=extip:51.159.82.58
      --maxpeers=200
      --bootnodes=enode://d860a01f9722d78051619d1e2351aba3f43f943f6f00718d1b9baa4101932a1f5011f16bb2b1bb35db20d6fe28fa0bf09636d26a87d31de9ec6203eeedb1f666@18.138.108.67:30303,enode://22a8232c3abc76a16ae9d6c3b164f98775fe226f0917b0ca871128a74a8e9630b458460865bab457221f1d448dd9791d24c4e5d88786180ac185df813a68d4de@3.209.45.79:30303,enode://2b252ab6a1d0f971d9722cb839a42cb81db019ba44c08754628ab4a823487071b5695317c8ccd085219c3a03af063495b2f1da8d18218da2d6a82981b45e6ffc@65.108.70.101:30303,enode://4aeb4ab6c14b23e2c4cfdce879c04b0748a20d8e9b59e25ded2a08143e265c6c25936e74cbc8e641e3312ca288673d91f2f93f8e277de3cfa444ecdaaf982052@157.90.35.166:30303
      --discovery.dns=all
      --discovery.v4
      --discovery.v5
      --txpool.accountslots=128
      --txpool.globalslots=50000
      --txpool.globalqueue=50000
      --txpool.pricelimit=0
      --txpool.pricebump=5
      --txpool.lifetime=3h
      --db.pagesize=16k
      --db.size.limit=8TB
      --torrent.download.rate=2048mb
      --torrent.upload.rate=1024mb
      --log.console.verbosity=info
      --log.dir.path=/var/lib/erigon/logs
      --log.dir.verbosity=debug
      --metrics
      --metrics.addr=0.0.0.0
      --metrics.port=6060
      --pprof
      --pprof.addr=0.0.0.0
      --pprof.port=6061
      --private.api.addr=0.0.0.0:9091
      --p2p.protocol=68,67,66
      --snapshots=true
      --batchsize=512MB
    ports:
      - "8545:8545"     # HTTP RPC
      - "8546:8546"     # WebSocket RPC  
      - "30303:30303"   # P2P
      - "8551:8551"     # Auth RPC
      - "6060:6060"     # Metrics
      - "6061:6061"     # pprof
      - "9091:9091"     # Private API
    volumes:
      - erigon_mev_data:/var/lib/erigon
    networks:
      - mev_network
    environment:
      - GOMAXPROCS=8
      - GOMEMLIMIT=20GiB
    deploy:
      resources:
        limits:
          memory: 24G
          cpus: '8.0'
        reservations:
          memory: 16G
          cpus: '4.0'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545", "-d", '{"jsonrpc":"2.0","method":"net_peerCount","params":[],"id":1}']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "10"
    labels:
      - "com.mev.service=erigon"
      - "com.mev.type=ethereum-mainnet"
      - "com.mev.optimized=true"